---
title: "NMR metabolites and hypertension"
author: "Joonatan Palmu"
date: "`r format(Sys.time(), '%d.%m.%Y')`"
output: 
  html_document:
    number_sections: true
---

```{r options, include=FALSE}
knitr::opts_chunk$set(include = TRUE, echo = TRUE, message = FALSE, results='asis', cache=FALSE, warning=FALSE)
options(knitr.kable.NA = "")
now <- format(Sys.time(), '%Y%m%d-%H%M%S')
```

```{r Command line arguments, include = FALSE, eval = FALSE}
file <- paste0("session/", sort(list.files("session"), decreasing = TRUE)[1])
message("Loading variables from file ", file)
load(file)
```

# Libraries

<details><summary>Libaries</summary>

```{r libraries, results = 'hide'}
# BASIC
library(magrittr)
library(knitr)
library(kableExtra)
library(tidyr)
library(broom)
# MODELING
library(dplyr)
library(parallel)
library(doMC)
library(officer)
library(flextable)
library(lme4)
# PLOT
library(ggplot2)
library(ggrepel)
library(ggeffects)
library(isoband)
library(randomForest)
library(png)
library(RColorBrewer)
library(ggquiver)
library(ggcorrplot)
# OTHER
library(Boruta)
library(pander)
library(caret)
library(pROC)
library(broom.mixed)
library(haven)
library(readxl)
library(openxlsx)
library(ggforestplot)
library(patchwork)
library(ggfortify)
library(cluster)
library(tableone)
library(purrr)
library(nnet)
library(ordinal)
library(egg)
library(gridExtra)
library(sure)
library(stringr)
library(haven)
library(car)
library(xfun)
library(PredictABEL)
library(pROC)
library(stargazer)
library(nricens)
library(metafor)
```

</details>

## Functions

<details><summary>Functions</summary>

```{r Functions}
sourcefiles <- c("articles-functions.R",
                 "articles-models.R",
                 "articles-plots.R",
                 "articles-tables.R")
```

```{r import files, echo = FALSE}
for (f in sourcefiles) {
    source(f)
}
```

```{r embbed files, echo = FALSE}
xfun::embed_files(c("rrnmr.Rmd", sourcefiles))
```

</details>

# Definitions

```{r definitions}
dvars <- c("sys", "dias", "htn")
ivars <- c("age", "female", "bmi", "smoker", "diabetes", "leisure", "bptreat", "koltreat", "cohort")
```

# Data import

```{r import raw data}
dset <- readRDS("rds/dset-20200820-184513.rds")
metabolites <- getmetabolites(dset$crosssectional)
```

## Characteristics

<details><summary>Cross-sectional sample</summary>

```{r tableone cross-sectional, echo = FALSE}
characteristicsTableFull(dset$crosssectional, test = TRUE) %>% mykable
```

</details>

<details><summary>Longitudinal sample</summary>

```{r tableone longitudinal, echo = FALSE}
characteristicsTableFull(dset$longitudinal) %>% mykable
```

</details>


## Cross-sectional associations

### Associations between metabolites and htn

```{r plot cross-sectional models}
glm.sys <- loop.lm(dset$crosssectional, "sys", metabolites, ivars)
glm.dias <- loop.lm(dset$crosssectional, "dias", metabolites, ivars)
glm.htn <- loop.binomial(dset$crosssectional, "htn", metabolites, ivars)
results.crosssectional <- loop.results(glm.sys, glm.dias, glm.htn)
```

<details><summary>Logistic model</summary>

```{r ggforestplot for logistic models,  results = 'hide', echo = FALSE}
myforestplot(results.crosssectional,
             xlim = c(0.7, 1.5),
             dims = c(18, 23),
             logodds = TRUE,
             responses = c("htn"),
             file = "cache/glmforest-crosssectional-htn.png")
```

<img src="cache/glmforest-crosssectional-htn.png" />

</details>

<details><summary>Linear models</summary>

```{r ggforestplot for linear models,  results = 'hide', echo = FALSE}
myforestplot(results.crosssectional,
             xlim = c(-2, 3),
             dims = c(18, 23),
             responses = c("sys", "dias"),
             file = "cache/glmforest-crosssectional-bp.png")
```

<img src="cache/glmforest-crosssectional-bp.png" />

</details>

<details><summary>Lipoprotein subclasses</summary>


```{r ggforestplot for linear model subclasses,  results = 'hide', echo = FALSE}
myforestplot(results.crosssectional,
             xlim = c(-2, 6),
             dims = c(18, 33),
             responses = c("sys", "dias"),
             panelone = c("Very low-density lipoprotein",
                          "Intermediate-density lipoprotein"),
             paneltwo = c("Low-density lipoprotein",
                          "High-density lipoprotein",
                          "General lipoprotein subclasses"),
             preprocess = subclasspreprocess,
             file = "cache/glmforest-crosssectional-liposubclasses-bp.png")
```

<img src = "cache/glmforest-crosssectional-liposubclasses-bp.png" />

</details>

<details><summary>Residuals</summary>

```{r residuals, fig.width=8, fig.height=20, echo = FALSE}
ggsave(file="cache/glmforest-crosssectional-residuals-sys.png",
       arrangeGrob(grobs = loop.residuals(glm.sys), ncol = 4),
       height = 49,
       width = 8,
       dpi = 300,
       unit = "in")
```

<img src="cache/glmforest-crosssectional-residuals-sys.png" />

```{r longitudinal qq, echo = FALSE}
ggsave(file = "cache/glmforest-crosssectional-htn-qq.png",
       plot = grid.arrange(grobs = loop.qq(glm.htn), ncol = 4),
       height = 49,
       width = 8,
       dpi = 300,
       unit = "in")
```

<img src = "cache/glmforest-crosssectional-htn-qq.png" />

</details>

<details><summary>Numerical values</summary>

```{r ggforestplot numeric values, echo = FALSE}
results.crosssectional %>% 
    results.table %>%
    mykable
```

</details>

### Compare young and old

```{r crosssectional young and old}
glm.age.young <- dset$crosssectional %>%
    filter(agegroup == "young") %>%
    rename(young = htn) %>%
    loop.binomial(., "young", metabolites, ivars)

glm.age.old <- dset$crosssectional %>%
    filter(agegroup == "old") %>%
    rename(old = htn) %>%
    loop.binomial(., "old", metabolites, ivars)

glm.age <- loop.results(glm.age.young, glm.age.old)
```

<details><summary>Logistic models</summary>

```{r ggforestplot crosssectional age model, echo = FALSE}
myforestplot(glm.age,
             xlim = c(0.7, 1.5),
             dims = c(18, 23),
             logodds = TRUE,
             scale = agescale,
             responses = c("old", "young"),
             file = "cache/glmforest-crosssectional-age.png")
```

<img src = "cache/glmforest-crosssectional-age.png" />

</details>

<details><summary>Numerical values</summary>

```{r ggforestplot age diff numeric values, echo = FALSE}
glm.age %>% 
    results.table %>%
    mykable
```

</details>

### Compare sex

```{r crosssectional sex}
glm.sex.female <- dset$crosssectional %>%
    filter(female == 1) %>%
    rename(sexfemale = htn) %>%
    loop.binomial(., "sexfemale", metabolites, ivars %difference% "female")

glm.sex.male <- dset$crosssectional %>%
    filter(female == 0) %>%
    mutate(sexmale = htn) %>%
    loop.binomial(., "sexmale", metabolites, ivars %difference% "female")

glm.sex <- loop.results(glm.sex.male, glm.sex.female)
```

<details><summary>Logistic models</summary>

```{r ggforestplot crosssectional sex model, echo = FALSE}
myforestplot(glm.sex,
             xlim = c(0.7, 1.5),
             dims = c(18, 23),
             logodds = TRUE,
             scale = sexscale,
             responses = c("sexfemale", "sexmale"),
             file = "cache/glmforest-crosssectional-sex.png")
```

<img src = "cache/glmforest-crosssectional-sex.png" />

</details>

<details><summary>Numerical values</summary>

Numerical values

```{r ggforestplot sex diff numeric values, echo = FALSE}
glm.sex %>% 
    results.table %>%
    mykable
```

</details>

### Comparing cross-sectional samples

```{r Comparing cross-sectional samples}
glm.compare <- dset$crosssectional %>%
    group_by(cohort) %>% 
    dplyr::do(loop.binomial(., "htn", metabolites, ivars %difference% "cohort") %>%
              loop.results) %>%
    ungroup %>%
    mutate(response = cohort)
```

<details><summary>Comparing cross-sectional samples</summary>

```{r comparing crosssectional samples plot, echo = FALSE}
myforestplot(glm.compare,
             xlim = c(0.4, 2.5),
             dims = c(18, 23),
             logodds = TRUE,
             responses = c("1997", "2002", "2007", "2012", "T2000"),
             file = "cache/glmforest-crosssectional-cohort.png",
             scale = cohortscale)
```

<img src = "cache/glmforest-crosssectional-cohort.png" />

</details>

## Longitudinal set

```{r longitudinal model}
glm.longitudinal.sys <- loop.lm(dset = getincidental(dset$longitudinal),
                                response = "sys.followup",
                                loops = metabolites,
                                covariates = ivars %union% "sys")
```

<details><summary>Numerical values for systole</summary>

```{r longitudinal model numerical results sys, echo = FALSE}
( results.longitudinal <- loop.results(glm.longitudinal.sys) ) %>%
    results.table %>%
    mykable    
```

</details>

<details><summary>Plot systole</summary>

```{r ggforestplot for incidental model all }
myforestplot(results.longitudinal,
             responses = "sys.followup",
             logodds = FALSE,
             xlim = c(-2, 3),
             dims = c(18, 23),
             file = "cache/glmforest-longitudinal-sys.png")
```

<img src = "cache/glmforest-longitudinal-sys.png" />

</details>

<details><summary>Lipoprotein subclasses</summary>


```{r ggforestplot for longitudinal model subclasses,  results = 'hide', echo = FALSE}
myforestplot(results.longitudinal %>% filter(std.error < 10000),
             xlim = c(-2, 2),
             dims = c(18, 28),
             responses = "sys.followup",
             panelone = c("Very low-density lipoprotein",
                          "Intermediate-density lipoprotein"),
             paneltwo = c("Low-density lipoprotein",
                          "High-density lipoprotein",
                          "General lipoprotein subclasses"),
             preprocess = subclasspreprocess,
             file = "cache/glmforest-longitudinal-liposubclasses-bp.png")
```

<img src = "cache/glmforest-crosssectional-liposubclasses-bp.png" />

</details>

<details><summary>Residuals systole</summary>

```{r longitudinal residuals sys, echo = FALSE}
ggsave(file = "cache/residuals-longitudinal-sys.png",
       plot = grid.arrange(grobs = loop.residuals(glm.longitudinal.sys), ncol = 4),
       height = 49,
       width = 8,
       dpi = 300,
       unit = "in")
```

<img src = "cache/residuals-longitudinal-sys.png" />

```{r longitudinal qq sys, echo = FALSE}
ggsave(file = "cache/qq-longitudinal-sys.png",
       plot = grid.arrange(grobs = loop.qq(glm.longitudinal.sys), ncol = 4),
       height = 49,
       width = 8,
       dpi = 300,
       unit = "in")
```

<img src = "cache/qq-longitudinal-sys.png" />

</details>

## Meta-analyses for main results

### Cross-sectional


```{r meta-analysis for cross-sectional}
glm.meta.sys <- loop.rma(dset = dset$crosssectional,
                         response = "sys",
                         loops = metabolites,
                         covariates = ivars %difference% "cohort") %>%
    loop.results(usemodelterm = TRUE) %>%
    mutate(response = "sys")

glm.meta.dias <- loop.rma(dset = dset$crosssectional,
                         response = "dias",
                         loops = metabolites,
                         covariates = ivars %difference% "cohort") %>%
    loop.results(usemodelterm = TRUE) %>%
    mutate(response = "dias")

glm.meta <- rbind(glm.meta.sys, glm.meta.dias)
```

<details><summary>Linear models</summary>

```{r ggforestplot for linear meta-analysis models,  results = 'hide', echo = FALSE}
myforestplot(glm.meta,
             xlim = c(-2, 3),
             dims = c(18, 23),
             responses = c("sys", "dias"),
             file = "cache/glmforest-crosssectional-bp-meta.png")
```

<img src="cache/glmforest-crosssectional-bp-meta.png" />

</details>


### Longitudinal

```{r meta-analysis for longitudinal}
glm.longitudinal.meta.sys <- loop.rma(dset = getincidental(dset$longitudinal),
                                      response = "sys.followup",
                                      loops = metabolites,
                                      covariates = ivars %union% "sys" %difference% "cohort") %>%
    loop.results(usemodelterm = TRUE) %>%
    mutate(response = "sys.followup")
```

<details><summary>Linear models</summary>

```{r ggforestplot for longitudinal models,  results = 'hide', echo = FALSE}
myforestplot(glm.longitudinal.meta.sys,
             xlim = c(-2, 3),
             dims = c(18, 23),
             responses = "sys.followup",
             file = "cache/glmforest-longitudinal-sys-meta.png")
```

<img src="cache/glmforest-longitudinal-sys-meta.png" />

</details>


# Supplement

<details><summary>Metabolite names</summary>

```{r metabolite names, echo = FALSE}
lapply(c2l(metabolites), function(x)
    data_frame(abbreviation = bioproperty(x),
               description = bioproperty(x, "description"),
               group = bioproperty(x, "group"),
               N = sum(!is.na(dset$crosssectional[[x]])),
               mean = attr(dset$crosssectional[[x]], "scaled:center"),
               sd = attr(dset$crosssectional[[x]], "scaled:scale"),
               unit = bioproperty(x, "unit"))) %>%
    purrr::map_df(., ~as.data.frame(.x)) %>%
    mutate_at(vars(mean, sd), round, 3) %>%
    arrange(abbreviation) %>%
    mykable
```

</details>
