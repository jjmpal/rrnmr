---
title: "NMR metabolites and hypertension"
author: "Joonatan Palmu"
date: "`r format(Sys.time(), '%d.%m.%Y')`"
output: 
  html_document:
    number_sections: true
---

```{r options, include=FALSE}
knitr::opts_chunk$set(include = TRUE, echo = TRUE, message = FALSE, results='asis', cache=FALSE, warning=FALSE)
options(knitr.kable.NA = "")
now <- format(Sys.time(), '%Y%m%d-%H%M%S')
```

```{r Command line arguments, include = FALSE, eval = FALSE}
file <- paste0("session/", sort(list.files("session"), decreasing = TRUE)[1])
message("Loading variables from file ", file)
load(file)
```

# Libraries

<details>

```{r libraries, results = 'hide'}
# BASIC
library(magrittr)
library(knitr)
library(kableExtra)
library(tidyr)
library(broom)
# MODELING
#library(MASS)
library(dplyr)
library(parallel)
library(doMC)
library(officer)
library(flextable)
library(lme4)
# PLOT
library(ggplot2)
library(ggrepel)
library(ggeffects)
library(isoband)
library(randomForest)
library(png)
library(RColorBrewer)
library(ggquiver)
library(ggcorrplot)
# OTHER
library(Boruta)
library(pander)
library(caret)
library(pROC)
library(broom.mixed)
library(haven)
library(readxl)
library(openxlsx)
library(ggforestplot)
library(patchwork)
library(ggfortify)
library(cluster)
library(tableone)
library(purrr)
library(nnet)
library(ordinal)
library(egg)
library(gridExtra)
library(sure)
library(stringr)
library(haven)
library(car)
library(xfun)
library(PredictABEL)
library(pROC)
library(stargazer)
library(nricens)
```

</details>

## Functions

<details><summary>Functions</summary>

```{r Functions}
sourcefiles <- c("articles-functions.R",
                 "articles-models.R",
                 "articles-plots.R",
                 "articles-tables.R")
```

```{r import files, echo = FALSE}
for (f in sourcefiles) {
    source(f)
}
```

```{r embbed files, echo = FALSE}
xfun::embed_files(c("rrnmr.Rmd", sourcefiles))
```

</details>

# Definitions

```{r definitions}
dvars <- c("sys", "dias", "htn")
ivars <- c("age", "female", "bmi", "smoker", "diabetes", "leisure", "bptreat", "koltreat", "cohort")
```

# Data import

```{r import raw data}
dset <- readRDS("rds/dset-20200214-153324.rds")
metabolites <- getmetabolites(dset$crosssectional)
```

## Data layout

<details>

### Cross-sectional QQ-plots

```{r data layout cross-sectional, echo = FALSE, fig.width=8, fig.height=10}
diagnosticqqplot(dset$crosssectional, metabolites)
```

### Cross-sectional correlation plot

```{r correlation plot cross-sectional, echo = FALSE, fig.width=8, fig.height=8}
mycorrplot(dset$crosssectional, metabolites)
```

</details>

## Characteristics

Cross-sectional sample

```{r tableone cross-sectional, echo = FALSE}
characteristicsTableFull(dset$crosssectional, test = TRUE) %>% mykable
```

Longitudinal sample

```{r tableone longitudinal, echo = FALSE}
characteristicsTableFull(dset$longitudinal) %>% mykable
```

## PCA

Calculating PCA in crossectional sample

```{r calculate PCA, fig.width=8, fig.height=20}
pca.df <- dset$crosssectional %>%
    myprcomp(.)
```

### PCA with systolic BP

```{r PCA}
ggsave(file = "cache/pca.png",
       plot = pca.plot(pca.df),
       height = 2.6,
       width = 4.9,
       dpi = 300,
       unit = "in")
```

<img src="cache/pca.png" />

Contribution of variables in main PCA axes

```{r Top contributors}
df.loading <- pca.df$loading %>%
    mutate(axisorder = PC1,
           nmrname = bioproperty(rowname),
           nmrgroup = bioproperty(rowname, "group")) %>% 
    dplyr::select(PC1, PC2, nmrname, nmrgroup)

arrangeGrob(grobs = lapply(c2l("PC1", "PC2"), function(x) df.loading %>% pca.loading(axis = x)),
            labels = c("A", "B"),
            ncol = 2) %>%
    ggsave(file = "cache/pca-proportion.png", plot = .,  height = 8, width = 8, dpi = 300)
```

<img src = "cache/pca-proportion.png" />

### Scatter plots for PCA axis

<details>

```{r PC1-PCn scatter plots}
pca.scatterplots(pca.df) %>%
    ggsave(file = "cache/pca-scatter.png", plot = ., height = 10, width = 15, dpi = 300)
```

<img src = "cache/pca-scatter.png" />

</details>

## Cross-sectional associations

### Associations between metabolites and htn

```{r plot residuals}
glm.sys <- loop.lm(dset$crosssectional, "sys", metabolites, ivars)
glm.dias <- loop.lm(dset$crosssectional, "dias", metabolites, ivars)
glm.htn <- loop.binomial(dset$crosssectional, "htn", metabolites, ivars)
glm <- loop.results(glm.sys, glm.dias, glm.htn)
```

Forset plot for continuous version of the plot

```{r ggforestplot for logistic models,  results = 'hide'}
myforestplot(glm,
             xlim = c(0.7, 1.5),
             dims = c(18, 21),
             logodds = TRUE,
             responses = c("htn"),
             file = "cache/glmforest-crosssectional-htn.png")
```

<img src="cache/glmforest-crosssectional-htn.png" />

<details><summary>Linear models</summary>

```{r ggforestplot for linear models,  results = 'hide', echo = FALSE}
myforestplot(glm,
             xlim = c(-2, 3),
             responses = c("sys", "dias"),
             file = "cache/glmforest-crosssectional-bp.png")
```

<img src="cache/glmforest-crosssectional-bp.png" />

</details>

<details><summary>Residuals</summary>

```{r residuals, fig.width=8, fig.height=20, echo = FALSE}
grid.arrange(grobs = loop.residuals(glm.htn), ncol = 4)
```

</details>

Numerical values

```{r ggforestplot numeric values, echo = FALSE}
glm %>% 
    results.table %>%
    select("term", "htn_mean_ci", "htn_p.value", "sys_mean_ci", "sys_p.value", "dias_mean_ci", "dias_p.value") %>%
    mykable
```

### Compare young and old

```{r crosssectional young and old}
glm.age.young <- dset$crosssectional %>%
    filter(agegroup == "young") %>%
    rename(young = htn) %>%
    loop.binomial(., "young", metabolites, ivars)
glm.age.old <- dset$crosssectional %>%
    filter(agegroup == "old") %>%
    rename(old = htn) %>%
    loop.binomial(., "old", metabolites, ivars)

glm.age <- loop.results(glm.age.young, glm.age.old)
```

```{r ggforestplot crosssectional age model, echo = FALSE }
myforestplot(glm.age,
             xlim = c(0.8, 1.5),
             logodds = TRUE,
             scale = agescale,
             responses = c("old", "young"),
             file = "cache/glmforest-crosssectional-age.png")
```

<img src = "cache/glmforest-crosssectional-age.png" />

Numerical values

```{r ggforestplot age diff numeric values, echo = FALSE}
glm.age %>% 
    results.table %>%
    mykable
```


<details><summary>Spline</summary>

```{r spline plot, echo = FALSE}
{ dset$crosssectional %>%
      gather(key, value, metabolites) %>%
      mutate(name = bioproperty(key, "name")) %>%
      ggplot(aes(x = age, y = value)) +
      facet_wrap(~name, ncol = 4, scales = "free_y") +
      geom_jitter(shape = ".", width = 0.5, alpha = 0.2) +
      geom_smooth(method = "gam", formula = y ~ s(x, bs = "cs")) +
      scale_x_continuous("Age") +
      scale_y_continuous("") +
      theme_classic() +
      theme(strip.background = element_blank(),
            strip.text.x = element_text(size = 10)) } %>%
    ggsave(file = "cache/spline-crosssectional.png", plot = ., height = 20, width = 8, dpi = 300, unit = "in")
```

<img src = "cache/spline-crosssectional.png" />

</details>

### Comparing cross-sectional samples

<details><summary>Comparing cross-sectional samples</summary>

```{r comparing crosssectional samples, echo = FALSE}
glm.compare <- dset$crosssectional %>%
    group_by(cohort) %>% 
    dplyr::do(loop.binomial(., "htn", metabolites, ivars %difference% "cohort") %>%
              loop.results) %>%
    ungroup %>%
    mutate(response = cohort)

myforestplot(glm.compare,
             xlim = c(0.5, 2.5),
             logodds = TRUE,
             responses = c("1997", "2002", "2007", "2012", "T2000"),
             file = "cache/glmcompare-crosssectional.png",
             dims = c(18, 24),
             scale = cohortscale)
```

<img src = "cache/glmcompare-crosssectional.png" />

</details>

## Longitudinal set

### Change in systolic bp

```{r model}
glm.longitudinal.htn <-  loop.binomial(getincidental(dset$longitudinal,
                                                     keephypertensive = TRUE),
                                       "htn.followup",
                                       metabolites,
                                       ivars %union% "sys")

results.longitudinal <- loop.results(glm.longitudinal.htn)
```

Correlation between HDL and systolic bp

```{r collinearity}
lapply(c2l("NMR_HDL_C", "NMR_HDL2_C", "NMR_ApoA1", "NMR_HDL_size"),
       function(x, df, method)
           data.frame(all = cor(df$sys, df[[x]], method = method),
                      normotensive = cor(df %>% filter(htn == 0) %>% pull(sys),
                                         df %>% filter(htn == 0) %>% pull(x),
                                         method = method),
                       hypertensive = cor(df %>% filter(htn == 1) %>% pull(sys),
                                         df %>% filter(htn == 1) %>% pull(x),
                                         method = method)),
       df = getincidental(dset$longitudinal, keephypertensive = TRUE),
       method = "spearman") %>%
    map_df(~.x, .id = "metabolite") %>%
    mykable
```

Numerical values

```{r longitudinal htn numerical table, echo = FALSE}
results.longitudinal %>% 
    results.table %>%
    mykable
```


```{r ggforestplot for incidental model all }
myforestplot(results.longitudinal,
             responses = "htn.followup",
             logodds = TRUE,
             xlim = c(0.7, 1.5),
             dims = c(18, 21),
             file = "cache/glmforest-longitudinal.png")
```

<img src = "cache/glmforest-longitudinal.png" />

<details><summary>Residuals</summary>

```{r longitudinal residuals, echo = FALSE}
ggsave(file = "cache/residuals-longitudinal.png",
       plot = grid.arrange(grobs = loop.residuals(glm.longitudinal.htn), ncol = 4),
       height = 20,
       width = 8,
       dpi = 300,
       unit = "in")
```

<img src = "cache/residuals-longitudinal.png" />

</details>

  
```{r save R image,  include = FALSE}
if (exists("rmdgeneration")) {
    rm(rmdgeneration)
}
save.image(file = paste0("session/session-", now, ".Rdata"))
```
